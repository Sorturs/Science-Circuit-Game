<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Review Game with AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; overflow-x: hidden; }
        .circuit-bg { background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); }
        .ai-glow { box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        .typing-dot { animation: typing 1.4s infinite; }
        @keyframes typing { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 circuit-bg flex flex-col items-center">

    <header class="w-full max-w-4xl flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-sky-400">‚ö° Circuit Lab <span class="text-xs font-normal text-slate-500 uppercase tracking-widest ml-2">AI Powered</span></h1>
        <div class="flex gap-2">
            <button onclick="toggleCheatSheet()" class="bg-amber-600 text-white font-bold py-1.5 px-3 rounded text-sm hover:bg-amber-500 transition-colors">CHEAT SHEET</button>
            <button onclick="toggleAIChat()" class="bg-sky-600 text-white font-bold py-1.5 px-3 rounded text-sm ai-glow hover:bg-sky-500 transition-colors">‚ú® AI ASSISTANT</button>
        </div>
    </header>

    <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Game Area -->
        <main id="game-container" class="lg:col-span-2 bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-xl relative">
            
            <!-- Progress Bar -->
            <div class="w-full bg-slate-900 h-1.5 rounded-full mb-6 overflow-hidden">
                <div id="progress-bar" class="bg-sky-500 h-full transition-all duration-500" style="width: 20%"></div>
            </div>

            <!-- Level Info -->
            <div id="screen-level">
                <div class="mb-4 flex justify-between items-start">
                    <div>
                        <h2 id="level-title" class="text-xl font-bold text-white mb-1">Level 1</h2>
                        <p id="level-instruction" class="text-slate-300 text-sm"></p>
                    </div>
                    <button onclick="requestAIHint()" class="text-xs bg-slate-700 text-sky-400 px-2 py-1 rounded hover:bg-slate-600">‚ú® AI HINT</button>
                </div>

                <!-- Circuit Drawing -->
                <div id="visual-area" class="bg-white rounded-lg p-6 mb-6 flex flex-col items-center justify-center border-2 border-slate-600 min-h-[200px]">
                    <!-- Circuit logic injected here -->
                </div>

                <!-- Input Area -->
                <div class="flex flex-col gap-4">
                    <div id="input-container" class="flex justify-center items-center gap-3">
                        <!-- Inputs injected here -->
                    </div>
                    <button onclick="checkAnswer()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition-all shadow-lg">CHECK ANSWER</button>
                </div>
            </div>

            <!-- Victory Screen -->
            <div id="screen-victory" class="hidden text-center py-10">
                <div class="mb-6 text-6xl">üèÜ</div>
                <h2 class="text-3xl font-bold text-emerald-400 mb-2">Review Complete!</h2>
                <p class="text-slate-300 mb-8">You've mastered the basics of current electricity.</p>
                <div class="flex flex-col gap-3 max-w-xs mx-auto">
                    <button onclick="generateAIPuzzle()" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-6 rounded-lg transition-all ai-glow">‚ú® GENERATE AI PUZZLE</button>
                    <button onclick="location.reload()" class="text-slate-500 text-sm hover:underline">Restart Original Levels</button>
                </div>
            </div>
        </main>

        <!-- AI Assistant Sidebar -->
        <aside id="ai-sidebar" class="bg-slate-900 border border-slate-700 rounded-xl flex flex-col h-[600px] shadow-2xl overflow-hidden hidden lg:flex">
            <div class="p-3 bg-slate-800 border-b border-slate-700 font-bold text-sky-400 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                ‚ú® Lab Assistant
            </div>
            <div id="ai-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm scrollbar-hide">
                <div class="bg-slate-800 p-3 rounded-lg border-l-2 border-sky-500 text-slate-300">
                    Hello! I'm your AI Lab Assistant. If you have questions about circuits or need a simpler explanation, just ask!
                </div>
            </div>
            <div class="p-3 bg-slate-800 border-t border-slate-700">
                <div class="flex gap-2">
                    <input type="text" id="ai-input" placeholder="Ask about electricity..." class="bg-slate-700 text-white text-xs p-2 rounded flex-1 focus:outline-none focus:ring-1 focus:ring-sky-500">
                    <button onclick="sendChatMessage()" class="bg-sky-600 p-2 rounded hover:bg-sky-500">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile AI Drawer (Hidden by default) -->
    <div id="mobile-ai-drawer" class="fixed inset-0 z-[100] bg-black/80 lg:hidden hidden">
        <div class="absolute bottom-0 left-0 right-0 h-3/4 bg-slate-900 rounded-t-2xl flex flex-col p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sky-400">‚ú® AI Assistant</h3>
                <button onclick="toggleAIChat()" class="text-slate-400 text-2xl">&times;</button>
            </div>
            <div id="ai-messages-mobile" class="flex-1 overflow-y-auto space-y-4 text-sm pb-4"></div>
            <div class="flex gap-2">
                <input type="text" id="ai-input-mobile" placeholder="Ask about electricity..." class="bg-slate-800 text-white text-sm p-3 rounded-xl flex-1 focus:outline-none">
                <button onclick="sendChatMessage(true)" class="bg-sky-600 px-4 rounded-xl">Send</button>
            </div>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-xl overflow-hidden shadow-2xl">
            <div id="fb-header" class="p-4 text-center font-bold text-lg text-white"></div>
            <div class="p-6">
                <p id="fb-text" class="text-slate-300 text-sm leading-relaxed mb-4"></p>
                <div id="ai-explanation-box" class="hidden mb-4 p-3 bg-sky-900/20 border-l-2 border-sky-400 text-xs italic text-sky-200">
                    <!-- AI simplified text -->
                </div>
                <div class="flex flex-col gap-2">
                    <button id="ai-explain-btn" onclick="askAISimpler()" class="w-full py-2 rounded font-bold text-sky-400 border border-sky-800 hover:bg-sky-900/30 text-xs">‚ú® ASK AI FOR SIMPLER EXPLANATION</button>
                    <button id="fb-btn" class="w-full py-2 rounded font-bold text-white"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cheat Sheet Modal -->
    <div id="cheat-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between mb-4 border-b border-slate-700 pb-2">
                <h2 class="text-xl font-bold text-amber-400">Study Cheat Sheet</h2>
                <button onclick="toggleCheatSheet()" class="text-slate-400 text-2xl">&times;</button>
            </div>
            <div class="space-y-6 text-sm">
                <div>
                    <p class="font-bold text-sky-400 mb-1">Ohm's Law: V = I √ó R</p>
                    <p class="text-slate-400">Voltage (V) = Current (I) √ó Resistance (R)</p>
                </div>
                <div class="bg-slate-800 p-3 rounded border border-slate-700">
                    <p class="font-bold text-yellow-500 mb-1">SERIES (One Loop)</p>
                    <p>‚Ä¢ <strong>Current</strong> is the SAME everywhere.</p>
                    <p>‚Ä¢ <strong>Voltage</strong> ADDS UP (Vt = V1 + V2).</p>
                    <p>‚Ä¢ <strong>Total Resistance</strong> adds up ($R_T = R_1 + R_2$).</p>
                </div>
                <div class="bg-slate-800 p-3 rounded border border-slate-700">
                    <p class="font-bold text-purple-500 mb-1">PARALLEL (Branches)</p>
                    <p>‚Ä¢ <strong>Voltage</strong> is the SAME on every branch.</p>
                    <p>‚Ä¢ <strong>Current</strong> ADDS UP ($I_T = I_1 + I_2$).</p>
                    <p>‚Ä¢ <strong>Total Resistance</strong> decreases as you add branches.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        const levels = [
            { id: 1, title: "Level 1: Ohm's Law", instr: "V = 12V, I = 2A. Find Resistance (R).", solution: {r: 6}, explain: "R = V / I (12 √∑ 2 = 6Œ©).", wrong: "Use R = V / I. Divide Voltage (12) by Current (2).", type: 'basic', val: {v: 12, i: 2, r: '?'}},
            { id: 2, title: "Level 2: Series Current", instr: "One Loop. Battery = 4A. What is I at bulb 2?", solution: {i: 4}, explain: "In series, current is the same everywhere!", wrong: "In series, current doesn't split. It stays 4A.", type: 'series', val: {i: 4, i2: '?'}},
            { id: 3, title: "Level 3: Series Voltage", instr: "Bulb 1 = 5V, Bulb 2 = 7V. Find Total Voltage (Vt).", solution: {vt: 12}, explain: "Voltages add up in series (5 + 7 = 12).", wrong: "Add the individual voltages to get the total battery voltage.", type: 'series', val: {v1: 5, v2: 7, vt: '?'}},
            { id: 4, title: "Level 4: Parallel Voltage", instr: "Battery = 9V. Bulbs are parallel. What is V1?", solution: {v: 9}, explain: "In parallel, every branch gets full battery voltage.", wrong: "Voltage is constant across parallel branches.", type: 'parallel', val: {vt: 9, v1: '?'}},
            { id: 5, title: "Level 5: Parallel Current", instr: "Branch 1 = 3A, Branch 2 = 2A. Find Total Current (It).", solution: {it: 5}, explain: "Current splits/adds in parallel (3 + 2 = 5).", wrong: "The total current is the sum of all branch currents.", type: 'parallel', val: {i1: 3, i2: 2, it: '?'}}
        ];

        let cur = 0;
        let isGenerating = false;

        async function callGemini(prompt, systemPrompt = "You are a helpful science tutor for Grade 9 students.") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error();
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    if (i === 4) return "AI currently busy. Please try again in a moment.";
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        function toggleCheatSheet() { document.getElementById('cheat-modal').classList.toggle('hidden'); }
        function toggleAIChat() { 
            const drawer = document.getElementById('mobile-ai-drawer');
            drawer.classList.toggle('hidden');
        }

        function loadLevel() {
            const l = levels[cur];
            document.getElementById('level-title').innerText = l.title;
            document.getElementById('level-instruction').innerText = l.instr;
            document.getElementById('progress-bar').style.width = `${((cur + 1) / levels.length) * 100}%`;
            document.getElementById('input-container').innerHTML = `<input type="number" id="ans" class="bg-slate-700 text-white p-3 rounded-lg text-center w-24 border border-slate-600 outline-none focus:ring-2 focus:ring-sky-500" placeholder="?"> <span class="text-slate-500 font-bold">VAL</span>`;
            draw(l);
        }

        function draw(l) {
            const area = document.getElementById('visual-area');
            let content = `<div class="w-full flex flex-col items-center gap-6">`;
            
            if (l.type === 'basic') {
                content += `
                    <div class="flex items-center gap-4 text-slate-900 font-mono text-xs">
                        <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üîã BATTERY (${l.val.v}V)</div>
                        <div class="h-0.5 w-12 bg-slate-400"></div>
                        <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üí° RESISTOR (${l.val.r}Œ©)</div>
                    </div>
                    <div class="text-slate-400 text-xs italic">Current flowing: ${l.val.i}A</div>
                `;
            } else if (l.type === 'series') {
                content += `
                    <div class="flex items-center gap-4 text-slate-900 font-mono text-xs">
                        <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üîã SOURCE</div>
                        <div class="h-0.5 w-8 bg-slate-400"></div>
                        <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üí° B1 (${l.val.v1 || l.val.i}V/A)</div>
                        <div class="h-0.5 w-8 bg-slate-400"></div>
                        <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üí° B2 (${l.val.v2 || l.val.i2}V/A)</div>
                    </div>
                `;
            } else if (l.type === 'parallel') {
                content += `
                    <div class="relative flex flex-col items-center gap-4 text-slate-900 font-mono text-xs">
                        <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded z-10">üîã SOURCE (${l.val.vt || ''}V)</div>
                        <div class="flex gap-12">
                            <div class="flex flex-col items-center">
                                <div class="w-0.5 h-6 bg-slate-400"></div>
                                <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üí° B1 (${l.val.v1 || l.val.i1}V/A)</div>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="w-0.5 h-6 bg-slate-400"></div>
                                <div class="p-3 border-2 border-slate-400 bg-slate-100 rounded">üí° B2 (${l.val.v2 || l.val.i2}V/A)</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            area.innerHTML = content + `</div>`;
        }

        function checkAnswer() {
            const l = levels[cur];
            const val = parseFloat(document.getElementById('ans').value);
            const isCorrect = val === Object.values(l.solution)[0];
            showFeedback(isCorrect);
        }

        function showFeedback(correct) {
            const modal = document.getElementById('feedback-modal');
            const l = levels[cur];
            document.getElementById('ai-explanation-box').classList.add('hidden');
            document.getElementById('ai-explain-btn').classList.toggle('hidden', correct);
            modal.classList.remove('hidden');
            
            const header = document.getElementById('fb-header');
            header.innerText = correct ? "CORRECT!" : "TRY AGAIN";
            header.className = `p-4 text-center font-bold text-lg text-white ${correct ? "bg-emerald-600" : "bg-rose-600"}`;
            
            document.getElementById('fb-text').innerText = correct ? l.explain : l.wrong;
            
            const btn = document.getElementById('fb-btn');
            btn.className = `w-full py-2 rounded font-bold text-white mt-2 ${correct ? "bg-emerald-600 hover:bg-emerald-500" : "bg-slate-700 hover:bg-slate-600"}`;
            btn.innerText = correct ? "NEXT LEVEL" : "GOT IT";
            
            btn.onclick = () => {
                modal.classList.add('hidden');
                if (correct) {
                    cur++;
                    if (cur < levels.length) loadLevel();
                    else {
                        document.getElementById('screen-level').classList.add('hidden');
                        document.getElementById('screen-victory').classList.remove('hidden');
                        document.getElementById('progress-bar').style.width = '100%';
                    }
                }
            };
        }

        async function askAISimpler() {
            const level = levels[cur];
            const btn = document.getElementById('ai-explain-btn');
            const box = document.getElementById('ai-explanation-box');
            
            btn.innerText = "‚ú® AI IS THINKING...";
            btn.disabled = true;

            const prompt = `The user is stuck on this electricity puzzle: "${level.instr}". 
                           The answer is ${Object.values(level.solution)[0]}. 
                           Explain why this is the answer using a simple analogy (like water or people in a line) for a 9th grade student who is confused. Keep it short.`;
            
            const response = await callGemini(prompt);
            box.innerText = response;
            box.classList.remove('hidden');
            btn.innerText = "‚ú® ASK AI FOR SIMPLER EXPLANATION";
            btn.disabled = false;
        }

        async function requestAIHint() {
            const l = levels[cur];
            addMessage("AI", "Thinking of a hint...", "sky");
            const prompt = `The student is on Level: ${l.title}. The instruction is: ${l.instr}. 
                           Give them a very small hint to nudge them in the right direction without giving the answer away.`;
            const hint = await callGemini(prompt);
            addMessage("AI", hint, "sky");
        }

        async function generateAIPuzzle() {
            if (isGenerating) return;
            isGenerating = true;
            const btn = event.target;
            const oldText = btn.innerText;
            btn.innerText = "‚ú® GENERATING PUZZLE...";
            
            const prompt = `Generate a JSON object for a NEW electricity puzzle for a Grade 9 student. 
                           Choose a random type (basic, series, or parallel). 
                           Ensure the values follow Ohm's Law and Circuit Rules.
                           Format: { "title": "AI Challenge", "instr": "Description", "solution": {"x": number}, "explain": "Short explanation", "wrong": "Hint", "type": "basic/series/parallel", "val": {object of numbers} }
                           Only return the raw JSON.`;
            
            try {
                const response = await callGemini(prompt, "You are a puzzle generator. Return valid JSON only.");
                const jsonStr = response.replace(/```json|```/g, '').trim();
                const newPuzzle = JSON.parse(jsonStr);
                
                // Add to current levels and reset game view
                levels.push(newPuzzle);
                cur = levels.length - 1;
                
                document.getElementById('screen-victory').classList.add('hidden');
                document.getElementById('screen-level').classList.remove('hidden');
                loadLevel();
                addMessage("AI", "I've created a custom challenge for you! Good luck.", "emerald");
            } catch (e) {
                addMessage("AI", "I had trouble generating that puzzle. Let's try again.", "rose");
            } finally {
                btn.innerText = oldText;
                isGenerating = false;
            }
        }

        async function sendChatMessage(isMobile = false) {
            const inputId = isMobile ? 'ai-input-mobile' : 'ai-input';
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;

            addMessage("You", text, "slate", isMobile);
            input.value = "";

            const response = await callGemini(text, "You are a helpful science lab assistant for Grade 9 students studying Current Electricity. Keep answers brief and encouraging.");
            addMessage("AI", response, "sky", isMobile);
        }

        function addMessage(sender, text, color, isMobile = false) {
            const containerId = isMobile ? 'ai-messages-mobile' : 'ai-messages';
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg border-l-2 border-${color}-500 ${sender === 'AI' ? 'bg-slate-800' : 'bg-slate-700'} text-xs`;
            div.innerHTML = `<strong class="text-${color}-400">${sender}:</strong> ${text}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            // Mirror to desktop if on mobile or vice versa
            if (!isMobile) {
                const mobileContainer = document.getElementById('ai-messages-mobile');
                const mDiv = div.cloneNode(true);
                mobileContainer.appendChild(mDiv);
            }
        }

        window.onload = loadLevel;
    </script>
</body>
</html>
